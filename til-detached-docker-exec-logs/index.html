<!DOCTYPE html>
<html lang="en">
<head>  
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Personal website">

<title>Neville Omangi</title>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

<link rel="stylesheet" href="/css/tailwind.css">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
<link href="https://unpkg.com/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet">

</head>

<body> 
  <nav class="px-4">
  <ul>
    <li>
      <a href="/" class="secondary">
        <strong>Neville Omangi</strong>
      </a>
    </li>
  </ul>

  <ul>
    <li><a href="/#bio">Bio</a></li>
    <li><a href="/#projects">Projects</a></li>
    
    <li><a href="/posts">Blog</a></li>
    <!--
    <li><a 
      href="https://docs.google.com/document/d/1r0hTXL7sNq7EnGPZNs5T8jXwqwEtJBMpi26Kk6EgkFQ/edit?usp=sharing"
      class="external"
    >Resume</a></li> -->
  </ul>
</nav>


  <main class="container">
    <section class="mx-auto max-w-[65ch] post">
      <div>
        <h1 class="">TIL: Detached docker exec logs</h1>
        
        <p>My Docker adventures haven't ended <a href="https://aphilas.github.io/til-python-output-buffering/">yet</a>, but I have run into another issue.</p>
<p>If you have a running Docker Compose service, and then you use <code>docker compose exec -d</code>, how do you read the <code>stdout</code> of the <em>child</em> process? Note that this is analogous or even equivalent to running a Docker container and then using <code>docker run</code>.</p>
<p>For example, say you have the following:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span><br>  <span class="token key atrule">docker-exec</span><span class="token punctuation">:</span><br>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.36</span><br>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"--"</span><span class="token punctuation">,</span> <span class="token string">"echo Hello from Parent\n while true; do sleep 30; done;"</span> <span class="token punctuation">]</span></code></pre>
<p>If you run the <em>main</em> service with <code>docker compose up</code> (optionally with the <code>-d</code> flag), you can see the logs with <code>docker compose logs</code> which yields:</p>
<pre><code>[+] Running 1/1
 ⠿ Container docker-exec-docker-exec-1  Recreated                                                                                1.0s
Attaching to docker-exec-docker-exec-1
docker-exec-docker-exec-1  | Hello from Parent
</code></pre>
<p>Whilst the service is running, run an attached (but technically <em>detached</em>) process with <code>docker compose exec -d</code> thus:</p>
<pre class="language-sh"><code class="language-sh"><span class="token function">docker</span> compose <span class="token builtin class-name">exec</span> <span class="token parameter variable">-d</span> docker-exec /bin/sh <span class="token parameter variable">-c</span> 'echo Hello from Child <span class="token operator">&amp;&amp;</span> <span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">sleep</span> <span class="token number">30</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span class="token punctuation">;</span></code></pre>
<p>As a detached <em>execution</em>, the command runs in the background and the shell reverts control back to you including not printing the expected output.</p>
<p>Running <code>docker compose logs</code> won't show the new message &quot;Hello from Child&quot;, but only the <code>stdout</code> from the main process i.e. the &quot;Parent.&quot;</p>
<p>A poster on <a href="https://stackoverflow.com/a/42959071/6567303">StackOverflow</a> shed some light on the mechanics of pseudo-TTYs and the interaction with Docker. Unfortunately (or not) it revealed how much I don't know about terminals (or shells for that matter).</p>
<p>Essentially, you can see the original process is being sent (piped) to the Docker logging library:</p>
<pre><code>$ ps -ef | grep Parent
root     31482 31459  0 15:05 ?        00:00:00 /bin/sh -c -- echo Hello from Parent  while true; do sleep 30; done;

$ ls -l /proc/31482/fd/1
l-wx------ 1 root root 64 Feb  7 15:50 /proc/31482/fd/1 -&gt; 'pipe:[245565]'
</code></pre>
<p>On the other hand, the <code>stdout</code> from the <em>child</em> process is sent to a pseudo-TTY:</p>
<pre><code>$ ps -ef | grep Child
root      2462 31459  0 15:11 pts/0    00:00:00 /bin/sh -c echo Hello from Child &amp;&amp; while true; do sleep 30; done;

$ ls -l /proc/2462/fd/1
lrwx------ 1 root root 64 Feb  7 15:53 /proc/2462/fd/1 -&gt; /dev/pts/0
</code></pre>
<p>You could see the pseudo-TTYs output with <code>cat /dev/pts/0</code> which essentially <em>tails</em> it.</p>
<p>It seems unlikely that you'd be able to recover the older logs from that pseudo-TTY but if chance upon a solution I will be sure to update this post.</p>
<p>There's an ongoing issue <a href="https://github.com/moby/moby/issues/8662">moby/moby#8662</a> that might be addressing this &quot;problem.&quot;</p>
<p>Resources:</p>
<ul>
<li><a href="https://docs.docker.com/engine/reference/commandline/exec/"><code>docker-exec</code> logs</a></li>
</ul>
<hr>
<p>Other TIL Docker easter eggs:</p>
<ul>
<li>After running <code>docker compose up</code> to see the output of a service, you can detached the process without exiting with the key sequence <code>Ctrl-p Ctrl-q</code>.</li>
<li>You can run a local script inside the container with redirection, for example: <code>docker compose exec -d -T service python &lt; test.py</code> obviating the need for a volume or rebuilding the container to run one-off scripts.</li>
</ul>
<hr>
<p>Did I get something wrong? Would you want to shed more light on anything I have addressed? Feel free to shoot me an email at aphilas [underscore] [at] outlook [dot] com.</p>


      </div>
    </section>
  </main>

  <footer class="container">
  <p>
    <small>  
      <a href="https://mastodon.online/@aphilas">Mastodon</a>  • 
      <a href="https://github.com/aphilas">GitHub</a> • 
      <a href="mailto:nevilleomangi@gmail.com">Email</a> •   
      <a href="https://www.linkedin.com/in/neville-omangi-62b290173/">LinkedIn</a>
    </small>
  </p>

  <p>
    <small>
        <span class="inline-block rotate-180">&copy;</span>
        2022 Neville Omangi. No rights reserved.
    </small>
  </p>
</footer>

</body>
</html>
